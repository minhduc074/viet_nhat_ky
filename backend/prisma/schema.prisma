// This is your Prisma schema file for Viet Nhat Ky (Micro-journaling app)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores user authentication data
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("user") // "user" or "admin"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relation to daily entries
  entries DailyEntry[]

  // Relation to monthly insights
  insights MonthlyInsight[]

  // Relation to AI usage logs
  aiUsages AIUsage[]

  @@map("users")
}

// DailyEntry model - stores daily mood check-ins
model DailyEntry {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime @db.Date // Only stores date, not time
  moodScore Int      @map("mood_score") // 1-5: 1=Tệ, 2=Không tốt, 3=Bình thường, 4=Tốt, 5=Tuyệt vời
  note      String?  // Optional short note
  tags      String[] @default([]) // Tags like ["Công việc", "Gia đình"]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relation to user
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensure one entry per user per day
  @@unique([userId, date])
  @@map("daily_entries")
}

// MonthlyInsight model - stores AI-generated monthly insights
model MonthlyInsight {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  month     String   // Format: YYYY-MM (e.g., "2026-01")
  insight   String   @db.Text // AI-generated insights and advice
  totalEntries Int   @default(0) @map("total_entries")
  avgMood   Float    @default(0) @map("avg_mood")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relation to user
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensure one insight per user per month
  @@unique([userId, month])
  @@index([userId, month])
  @@map("monthly_insights")
}

// AIUsage model - tracks AI API calls and usage statistics
model AIUsage {
  id             String   @id @default(cuid())
  userId         String?  @map("user_id") // Nullable for system-wide requests
  provider       String   // "chatgpt" or "gemini"
  endpoint       String   // API endpoint called
  promptTokens   Int      @default(0) @map("prompt_tokens")
  responseTokens Int      @default(0) @map("response_tokens")
  totalTokens    Int      @default(0) @map("total_tokens")
  success        Boolean  @default(true) // Whether the call succeeded
  errorMessage   String?  @map("error_message") @db.Text
  responseTimeMs Int      @map("response_time_ms") // Response time in milliseconds
  createdAt      DateTime @default(now()) @map("created_at")

  // Relation to user (optional)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([provider])
  @@index([createdAt])
  @@map("ai_usages")
}
