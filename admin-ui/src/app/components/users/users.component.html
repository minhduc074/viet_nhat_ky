<div class="users-container">
  <div class="header">
    <h1>User Management</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">+ Create User</button>
  </div>

  <div class="search-bar">
    <input 
      type="text" 
      [(ngModel)]="searchQuery" 
      (keyup.enter)="onSearch()"
      placeholder="Search by email or name..."
      class="search-input"
    />
    <button class="btn btn-secondary" (click)="onSearch()">Search</button>
  </div>

  <div *ngIf="loading" class="loading">Loading users...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!loading && users.length === 0" class="no-data">
    No users found.
  </div>

  <div *ngIf="!loading && users.length > 0" class="users-content">
    <table class="data-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Role</th>
          <th>Status</th>
          <th>Entries</th>
          <th>AI Usage</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td>{{ user.email }}</td>
          <td>
            <span *ngIf="editingUser?.id !== user.id">{{ user.name || '-' }}</span>
            <input *ngIf="editingUser?.id === user.id" type="text" [(ngModel)]="editingUser!.name" />
          </td>
          <td>
            <span *ngIf="editingUser?.id !== user.id">{{ user.role }}</span>
            <select *ngIf="editingUser?.id === user.id" [(ngModel)]="editingUser!.role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </td>
          <td>
            <span *ngIf="editingUser?.id !== user.id" [class]="user.isActive ? 'badge active' : 'badge inactive'">
              {{ user.isActive ? 'Active' : 'Inactive' }}
            </span>
            <label *ngIf="editingUser?.id === user.id">
              <input type="checkbox" [(ngModel)]="editingUser!.isActive" /> Active
            </label>
          </td>
          <td>{{ user._count?.entries || 0 }}</td>
          <td>{{ user._count?.aiUsages || 0 }}</td>
          <td>{{ user.createdAt | date:'short' }}</td>
          <td class="actions">
            <span *ngIf="editingUser?.id !== user.id">
              <button class="btn-small btn-edit" (click)="editUser(user)">Edit</button>
              <button class="btn-small btn-delete" (click)="deleteUser(user)">Delete</button>
            </span>
            <span *ngIf="editingUser?.id === user.id">
              <button class="btn-small btn-success" (click)="saveUser()">Save</button>
              <button class="btn-small btn-cancel" (click)="cancelEdit()">Cancel</button>
            </span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div *ngIf="pagination" class="pagination">
      <button 
        class="btn btn-secondary" 
        (click)="goToPage(pagination.page - 1)"
        [disabled]="pagination.page === 1"
      >
        Previous
      </button>
      <span class="page-info">
        Page {{ pagination.page }} of {{ pagination.totalPages }} 
        ({{ pagination.total }} total)
      </span>
      <button 
        class="btn btn-secondary" 
        (click)="goToPage(pagination.page + 1)"
        [disabled]="pagination.page === pagination.totalPages"
      >
        Next
      </button>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Create New User</h2>
    <form (ngSubmit)="createUser()">
      <div class="form-group">
        <label>Email *</label>
        <input type="email" [(ngModel)]="newUser.email" name="email" required />
      </div>
      <div class="form-group">
        <label>Password *</label>
        <input type="password" [(ngModel)]="newUser.password" name="password" required />
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" [(ngModel)]="newUser.name" name="name" />
      </div>
      <div class="form-group">
        <label>Role</label>
        <select [(ngModel)]="newUser.role" name="role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group checkbox">
        <label>
          <input type="checkbox" [(ngModel)]="newUser.isActive" name="isActive" />
          Active
        </label>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create User</button>
      </div>
    </form>
  </div>
</div>
