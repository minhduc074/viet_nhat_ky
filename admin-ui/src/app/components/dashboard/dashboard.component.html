<div class="dashboard-container">
  <h1>Admin Dashboard</h1>

  <div *ngIf="loading" class="loading">Loading dashboard...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="stats && !loading" class="dashboard-content">
    <!-- Overview Cards -->
    <div class="cards-grid">
      <div class="card">
        <h3>Total Users</h3>
        <p class="stat-value">{{ formatNumber(stats.overview.totalUsers) }}</p>
        <p class="stat-detail">Active: {{ formatNumber(stats.overview.activeUsers) }}</p>
      </div>

      <div class="card">
        <h3>Total Entries</h3>
        <p class="stat-value">{{ formatNumber(stats.overview.totalEntries) }}</p>
      </div>

      <div class="card">
        <h3>Monthly Insights</h3>
        <p class="stat-value">{{ formatNumber(stats.overview.totalInsights) }}</p>
      </div>

      <div class="card">
        <h3>AI API Calls</h3>
        <p class="stat-value">{{ formatNumber(stats.overview.totalAIUsages) }}</p>
      </div>
    </div>

    <!-- AI Usage Statistics (Last 30 Days) -->
    <div class="section">
      <h2>AI Usage (Last 30 Days)</h2>
      
      <div class="cards-grid">
        <div class="card">
          <h3>Total Calls</h3>
          <p class="stat-value">{{ formatNumber(stats.aiUsage.last30Days.totalCalls) }}</p>
          <p class="stat-detail success">✓ {{ formatNumber(stats.aiUsage.last30Days.successfulCalls) }}</p>
          <p class="stat-detail error">✗ {{ formatNumber(stats.aiUsage.last30Days.failedCalls) }}</p>
        </div>

        <div class="card">
          <h3>Success Rate</h3>
          <p class="stat-value">{{ formatPercent(stats.aiUsage.last30Days.successRate) }}</p>
        </div>

        <div class="card">
          <h3>Total Tokens</h3>
          <p class="stat-value">{{ formatNumber(stats.aiUsage.last30Days.totalTokens) }}</p>
          <p class="stat-detail">Prompt: {{ formatNumber(stats.aiUsage.last30Days.promptTokens) }}</p>
          <p class="stat-detail">Response: {{ formatNumber(stats.aiUsage.last30Days.responseTokens) }}</p>
        </div>

        <div class="card">
          <h3>Avg Response Time</h3>
          <p class="stat-value">{{ formatTime(stats.aiUsage.last30Days.avgResponseTime) }}</p>
        </div>
      </div>

      <!-- By Provider -->
      <h3>Usage by Provider</h3>
      <table class="data-table">
        <thead>
          <tr>
            <th>Provider</th>
            <th>Calls</th>
            <th>Total Tokens</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let provider of stats.aiUsage.last30Days.byProvider">
            <td>{{ provider.provider }}</td>
            <td>{{ formatNumber(provider.calls) }}</td>
            <td>{{ formatNumber(provider.totalTokens) }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Recent Users -->
    <div class="section">
      <h2>Recent Users <a routerLink="/users" class="view-all">View All →</a></h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of stats.recentUsers">
            <td>{{ user.email }}</td>
            <td>{{ user.name || '-' }}</td>
            <td>
              <span [class]="user.isActive ? 'badge active' : 'badge inactive'">
                {{ user.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td>{{ user.createdAt | date:'short' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Recent AI Usage -->
    <div class="section">
      <h2>Recent AI Requests <a routerLink="/ai-usage" class="view-all">View All →</a></h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>User</th>
            <th>Provider</th>
            <th>Tokens</th>
            <th>Response Time</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let usage of stats.aiUsage.recent">
            <td>{{ usage.createdAt | date:'short' }}</td>
            <td>{{ usage.user?.email || 'System' }}</td>
            <td>{{ usage.provider }}</td>
            <td>{{ formatNumber(usage.totalTokens) }}</td>
            <td>{{ formatTime(usage.responseTimeMs) }}</td>
            <td>
              <span [class]="usage.success ? 'badge success' : 'badge error'">
                {{ usage.success ? 'Success' : 'Failed' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
